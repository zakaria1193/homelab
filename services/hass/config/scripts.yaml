broadcast_tts:
  alias: broadcast tts
  description: ''
  mode: queued
  max: 10
  fields:
    text_to_broadcast:
      selector:
        text:
      required: true
      name: Text to broadcast
    language:
      selector:
        select:
          options:
          - fr
          - en
          multiple: false
      default: en
  sequence:
  - action: notify.mobile_app_cph2569
    metadata: {}
    data:
      message: '{{ text_to_broadcast }}'
  - condition: state
    entity_id: binary_sensor.time_based_speaker_authorization
    state: 'on'
  - variables:
      tts_player: '{{ states(''sensor.broadcast_tts_media_player'') }}'
  - action: media_player.volume_set
    metadata: {}
    target:
      entity_id: '{{ tts_player }}'
    data:
      volume_level: "{% if tts_player == 'media_player.nesthubmax03c5' %}\n  0.45\n{%
        else %}\n  0.46\n{% endif %}\n"
  - choose:
    - conditions:
      - condition: template
        value_template: '{{ language == ''en'' }}'
      sequence:
      - alias: TTS English
        action: tts.speak
        metadata: {}
        target:
          entity_id: tts.edge_tts_2
        data:
          cache: true
          media_player_entity_id: '{{ tts_player }}'
          language: en-GB-RyanNeural
          message: '{{ text_to_broadcast }}'
    - conditions:
      - condition: template
        value_template: '{{ language == ''fr'' }}'
      sequence:
      - alias: TTS French
        action: tts.speak
        metadata: {}
        target:
          entity_id: tts.edge_tts_2
        data:
          cache: true
          media_player_entity_id: '{{ tts_player }}'
          language: fr-BE-GerardNeural
          message: '{{ text_to_broadcast }}'
announce_next_bus_train:
  sequence:
  - variables:
      bus_threshold: 4
      train_threshold: 11
      bus_min: '{{ states(''sensor.minutes_to_next_bus'') }}'
      train_min: '{{ states(''sensor.minutes_to_next_train_l'') }}'
      bus_disrupted: '{{ is_state(''binary_sensor.bus_status'',''on'') }}'
      train_disrupted: '{{ is_state(''binary_sensor.l_line_status'',''on'') }}'
      bus_part: "{% if bus_disrupted %}\n  Bus 171 perturbé\n{% elif bus_min in ['unknown','unavailable','']
        %}\n  Horaire du bus 171 indisponible\n{% elif bus_min | int(99) > bus_threshold
        %}\n  {% set m = bus_min | int(99) %}\n  {% if m == 0 %}\n    Bus 171 arrive
        maintenant\n  {% elif m == 1 %}\n    Bus 171 dans 1 minute\n  {% else %}\n
        \   Bus 171 dans {{ m }} minutes\n  {% endif %}\n{% else %}\n  Pas de bus\n{%
        endif %}\n"
      train_part: "{% if train_disrupted %}\n  Ligne eL perturbée\n{% elif train_min
        in ['unknown','unavailable',''] %}\n  Horaire de la ligne eL indisponible\n{%
        elif train_min | int(99) > train_threshold %}\n  {% set m = train_min | int(99)
        %}\n  {% if m == 0 %}\n    Ligne eL arrive maintenant\n  {% elif m == 1 %}\n
        \   Ligne eL dans 1 minute\n  {% else %}\n    Ligne eL dans {{ m }} minutes\n
        \ {% endif %}\n{% else %}\n  Pas de train\n{% endif %}\n"
      full_message: "{% set parts = [bus_part, train_part]\n     | select('string')
        | map('trim') | reject('equalto','') | list %}\n{{ parts | join('. Et ') }}."
  - variables:
      ligne_L_status_summary: ''
  - if:
    - condition: state
      entity_id: binary_sensor.l_line_status
      state: 'off'
    then: []
    else:
    - data:
        instructions: "I am gonna give you the official status of Ligne L. and i want
          you to make a summary of how that is gonna affect me NOW.\ni live in chaville
          in the versaille branche of ligne L and i am interested in the paris saint
          lazare direction only. So ignore anything about Cergy branch or the Saint-Nom
          la breteche branch,\nTime now is {{ now().strftime('%A, %d %B %Y %H:%M:%S')
          }}\nI want the status in a single sentence. and don't repeat the instructions
          back at me. Answer in french.\nThis is gonna be read by a TTS, so make it
          readable (no special symbols).\nThis is the raw status:\n\n{{state_attr(\"calendar.l_line_calendar_maintenance\",
          \"description\")}}\n\n{{ \nstate_attr('binary_sensor.l_line_status', 'description')
          }}"
        task_name: Summarize ligne L status
        entity_id: ai_task.openai_ai_task
      response_variable: ligne_L_status_summary
      action: ai_task.generate_data
      enabled: true
    - delay:
        seconds: 1
    alias: AI generate ligne_L_status_summary
    enabled: true
  - alias: Announce All
    data:
      text_to_broadcast: '{{ full_message }}


        {{ ligne_L_status_summary }}'
      language: fr
    action: script.broadcast_tts
    enabled: true
  - action: input_text.set_value
    metadata: {}
    data:
      value: '{{ full_message }}


        {{ ligne_L_status_summary }}'
    target:
      entity_id: input_text.bus_train_summary
  alias: Announce next bus & train
  description: 'Builds a message like “Bus 171 in 7 min / Line L in 3 min” and sends
    or speaks it.

    '
  mode: single
  variables:
    bus_min: '{{ states(''sensor.minutes_to_next_bus'') }}'
    train_min: '{{ states(''sensor.minutes_to_next_train_l'') }}'
    bus_disrupted: '{{ is_state(''binary_sensor.bus_171_status'',''on'') }}'
    train_disrupted: '{{ is_state(''binary_sensor.l_line_status'',''on'') }}'
    bus_part: "{% if bus_disrupted %}\n  ⚠️ Bus 171 disrupted\n{% elif bus_min in
      ['unknown','unavailable'] %}\n  Bus 171 schedule unavailable\n{% elif bus_min
      | int(99) == 0 %}\n  Bus 171 arriving now\n{% elif bus_min | int == 1 %}\n  Bus
      171 in 1 minute\n{% else %}\n  Bus 171 in {{ bus_min }} minutes\n{% endif %}\n"
    train_part: "{% if train_disrupted %}\n  ⚠️ Line L disrupted\n{% elif train_min
      in ['unknown','unavailable'] %}\n  Line L schedule unavailable\n{% elif train_min
      | int(99) == 0 %}\n  Line L arriving now\n{% elif train_min | int == 1 %}\n
      \ Line L in 1 minute\n{% else %}\n  Line L in {{ train_min }} minutes\n{% endif
      %}\n"
    full_message: '{{ bus_part }} · {{ train_part }}'
ai_text_preproc_for_tts:
  sequence:
  - action: ai_task.generate_data
    metadata: {}
    data:
      instructions: 'This sentence is gonna be read by a TTS. make it readable (redable
        dates, no symbols etc...):

        "{{input}}"


        keep the original language.'
      task_name: AI text preproc for TTS
    response_variable: output
  - stop: done
    response_variable: output
  fields:
    input:
      selector:
        text:
      name: input
      required: true
  alias: AI text preproc for TTS
  description: ''
