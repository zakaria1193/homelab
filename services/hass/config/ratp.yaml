#############################
# 1â€Šâ€”â€ŠTemplate helpers
#############################
template:
  - sensor:
      # Minutes until the very next bus 171
      - name: "minutes_to_next_bus_171"
        unique_id: minutes_to_next_bus_171
        unit_of_measurement: "min"
        state: >
          {% set ts = states('sensor.bus_171_next_0') %}
          {% if ts not in ['unknown','unavailable',''] %}
            {{ ((as_timestamp(ts) - as_timestamp(now())) / 60) | round(0, default=0) }}
          {% else %}
            unknown
          {% endif %}

      # Minutes until the very next train on lineâ€¯L
      - name: "minutes_to_next_train_l"
        unique_id: minutes_to_next_train_l
        unit_of_measurement: "min"
        state: >
          {% set ts = states('sensor.l_line_next_0') %}
          {% if ts not in ['unknown','unavailable',''] %}
            {{ ((as_timestamp(ts) - as_timestamp(now())) / 60) | round(0, default=0) }}
          {% else %}
            unknown
          {% endif %}

#############################
# 2â€Šâ€”â€ŠReusable script
#############################
script:
  announce_next_transport:
    alias: "Announce next busÂ & train"
    description: >
      Builds a message like
      â€œBusâ€¯171 inâ€¯7â€¯min / Lineâ€¯L inâ€¯3â€¯minâ€ and sends or speaks it.
    mode: single

    # â”€â”€â”€â”€â”€â”€ VARIABLES â”€â”€â”€â”€â”€â”€
    variables:
      bus_min: "{{ states('sensor.minutes_to_next_bus_171') }}"
      train_min: "{{ states('sensor.minutes_to_next_train_l') }}"
      bus_disrupted: "{{ is_state('binary_sensor.bus_171_status','on') }}"
      train_disrupted: "{{ is_state('binary_sensor.l_line_status','on') }}"

      # Naturalâ€‘language snippets
      bus_part: >
        {% if bus_disrupted %}
          âš ï¸ Busâ€¯171 disrupted
        {% elif bus_min in ['unknown','unavailable'] %}
          Busâ€¯171 schedule unavailable
        {% elif bus_min | int(99) == 0 %}
          Busâ€¯171 arriving now
        {% elif bus_min | int == 1 %}
          Busâ€¯171 in 1â€¯minute
        {% else %}
          Busâ€¯171 in {{ bus_min }}â€¯minutes
        {% endif %}
      train_part: >
        {% if train_disrupted %}
          âš ï¸ Lineâ€¯L disrupted
        {% elif train_min in ['unknown','unavailable'] %}
          Lineâ€¯L schedule unavailable
        {% elif train_min | int(99) == 0 %}
          Lineâ€¯L arriving now
        {% elif train_min | int == 1 %}
          Lineâ€¯L in 1â€¯minute
        {% else %}
          Lineâ€¯L in {{ train_min }}â€¯minutes
        {% endif %}
      full_message: "{{ bus_part }} Â· {{ train_part }}"

    # â”€â”€â”€â”€â”€â”€ WHAT TO DO WITH IT â”€â”€â”€â”€â”€â”€
    # ğŸ‘‰  Replace the service below with one that suits you
    sequence:
      - service: notify.mobile_app_your_phone
        data:
          title: "Next departures"
          message: "{{ full_message }}"

      # If youâ€™d also like it spoken on a speaker, add:
      # - service: tts.google_say
      #   target: { entity_id: media_player.entrance_speaker }
      #   data: { message: "{{ full_message }}", cache: false }

#############################
# 3â€Šâ€”â€ŠExample daily automation (optional)
#############################
automation:
  - alias: "07â€¯h commute update"
    id: commute_update_07h
    trigger:
      - platform: time
        at: "07:00:00"
    condition:
      - condition: time         # only on work days
        weekday: [mon,tue,wed,thu,fri]
    action:
      - service: script.announce_next_transport

